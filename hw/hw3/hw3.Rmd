---
title: "Biostat 203B Homework 3"
subtitle: Due Feb 21 @ 11:59PM
output:
  # ioslides_presentation: default
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

## Task

Your task is to develop a Shiny app that visualizes the progression of the 2019-20 Global Coronavirus Outbreak. If you are ambitious, you can also bring in visualization of other types of data, e.g., stock market and so on.

Below is some data exploration, which may help you get started. Note below code may change frequently.

<!-- Johns Hopkins CSSE Visualization: <https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6> -->

<!-- Downloadable Google sheet: -->
<!-- <https://docs.google.com/spreadsheets/d/1wQVypefm946ch4XDp37uZ-wartW4V7ILdg-qYiDXUHM/edit#gid=787605648> -->

<!-- Time series table: <https://docs.google.com/spreadsheets/d/1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo/edit#gid=0> -->

```{r include=FALSE}
library(tidyverse)
library(googlesheets4)
library(lubridate)
```

## Import JHU Google Sheets into R

Johns Hopkins University (JHU) Center for Systems Science and Engineering (CSSE) kindly compiles, updates, and shares the current data on 2019-nCoV outbreak at Google Sheets: <https://docs.google.com/spreadsheets/d/1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo>.

We can use the tidyverse package [`googlesheets4`](https://googlesheets4.tidyverse.org) to import data from Google Sheets. Because the JHU sheets are public, we don't need authentication by tokens.
```{r}
# no authentication
sheets_deauth()
```
Import the `confirmed` sheet:
```{r}
(confirmed <- read_sheet("1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo", sheet = 2))
```
Import the `recovered` sheet:
```{r}
(recovered <- read_sheet("1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo", sheet = 3))
```
Import the `death` sheet:
```{r}
(death <- read_sheet("1UF2pSkFTURko2OvfHWWlFpDFAr1UxCBA4JLwlSP6KFo", sheet = 4))
```

## Tidy data

I want to tidy data into the long format. `pivot_longer` is the modern version of `gather` function in dplyr.
```{r}
confirmed_long <- confirmed %>%
  pivot_longer(-(`Province/State`:Long), 
               names_to = "time", 
               values_to = "confirmed") %>%
  mutate(time = mdy_hm(time))
confirmed_long
```
```{r}
recovered_long <- recovered %>%
  pivot_longer(-(`Province/State`:Long), 
               names_to = "time", 
               values_to = "recovered") %>%
  mutate(time = mdy_hm(time))
recovered_long
```
```{r}
death_long <- death %>%
  pivot_longer(-(`Province/State`:Long), 
               names_to = "time", 
               values_to = "death") %>%
  mutate(time = mdy_hm(time))
death_long
```

```{r}
ncov_tbl <- confirmed_long %>%
  left_join(recovered_long) %>%
  left_join(death_long)
ncov_tbl %>% print(width = Inf)
```

## Mapping China provinces

Some useful resources for mapping:  
- The book [_Geocomputation with R_](https://geocompr.robinlovelace.net). Especially [Chapter 8 Making Maps with R](https://geocompr.robinlovelace.net/adv-map.html).  
- The book [_An Introduction to Spatial Analysis and Mapping in R_](https://bookdown.org/lexcomber/brunsdoncomber2e/). 

### Use mapdata - **MAP IS TOO OLD**

The package `mapdata` contains a data `china`. But the map seems out-dated. For example, Chongqing is sill a part of Sichuan province in this map.
```{r}
suppressMessages(library(mapdata))
map("china", col = "gray40", ylim = c(18,54))
```

### Use GADM data - **THIS IS VERY SLOW**

Download GADM data for China at <https://www.gadm.org/download_country_v3.html>. There are 4 levels of details to plot. We opt for the level 1 which is at the province level.
```{r, eval = FALSE}
library(sf)
library(tidyverse)
gadm36_CHN_1_sf <- readRDS("gadm36_CHN_0_sf.rds")
ggplot(data = gadm36_CHN_1_sf) + 
  geom_sf()
```

```{r, eval = FALSE}
library("GADMTools")
map <- gadm_sp_loadCountries("CHN", level = 1, basefile = "./")
gadm_plot(map) + theme_light()
```

### Use shapefile from GADM - **THIS IS VERY SLOW**

```{r, eval = FALSE}
library(maptools)
map <- rgdal::readOGR("gadm36_CHN_shp/gadm36_CHN_1.shp")
plot(map)
```

### Use maptools and GIS data from China

Donwload China GIS data from [here](https://uploads.cosx.org/2009/07/chinaprovinceborderdata_tar_gz.zip), unzip, and put in the working directory.
```{bash}
ls -l bou2_4p.*
```
Read in the shape file into simple feature (SF) format:
```{r}
library(sf)
chn_map <- st_read("./bou2_4p.shp", as_tibble = TRUE) %>%
  mutate(NAME = iconv(NAME, from = "GBK"),
         BOU2_4M_ = as.integer(BOU2_4M_),
         BOU2_4M_ID = as.integer(BOU2_4M_ID)) %>%
  mutate(NAME = str_replace_na(NAME, replacement = "澳门特别行政区"))
class(chn_map)
```
`ggplot2` can plot SF data using `geom_sf` function:
```{r}
chn_map %>%
  ggplot() + 
  geom_sf(color = "black", fill = "white") + 
  theme_bw() # better for maps
chn_map %>% print(width = Inf)
```
There are about 34 provinces in China, why there are 925 areas?
```{r}
chn_map %>% 
  count(NAME) %>% 
  print(n = Inf)
```
These are the provinces available from the JHU sheets.
```{r}
ncov_tbl %>%
  filter(`Country/Region` %in% c("Mainland China", "Macau", "Hong Kong", "Taiwan")) %>%
  distinct(`Province/State`, `Country/Region`) %>%
  print(n = Inf)
```
We create a function to translate Chinese province name to English.
```{r}
translate <- function(x) {
  sapply(x, function(chn_name) {
    if (str_detect(chn_name, "澳门")) {
      eng_name <- "Macau"
    } else if (str_detect(chn_name, "台湾")) {
      eng_name <- "Taiwan"
    } else if (str_detect(chn_name, "上海")) {
      eng_name <- "Shanghai"
    } else if (str_detect(chn_name, "云南")) {
      eng_name <- "Yunnan"
    } else if (str_detect(chn_name, "内蒙古")) {
      eng_name <- "Inner Mongolia"
    } else if (str_detect(chn_name, "北京")) {
      eng_name <- "Beijing"
    } else if (str_detect(chn_name, "台湾")) {
      eng_name <- "Taiwan"
    } else if (str_detect(chn_name, "吉林")) {
      eng_name <- "Jilin"
    } else if (str_detect(chn_name, "四川")) {
      eng_name <- "Sichuan"
    } else if (str_detect(chn_name, "天津")) {
      eng_name <- "Tianjin"
    } else if (str_detect(chn_name, "宁夏")) {
      eng_name <- "Ningxia"
    } else if (str_detect(chn_name, "安徽")) {
      eng_name <- "Anhui"
    } else if (str_detect(chn_name, "山东")) {
      eng_name <- "Shandong"
    } else if (str_detect(chn_name, "山西")) {
      eng_name <- "Shanxi"
    } else if (str_detect(chn_name, "广东")) {
      eng_name <- "Guangdong"
    } else if (str_detect(chn_name, "广西")) {
      eng_name <- "Guangxi"
    } else if (str_detect(chn_name, "新疆")) {
      eng_name <- "Xinjiang"
    } else if (str_detect(chn_name, "江苏")) {
      eng_name <- "Jiangsu"
    } else if (str_detect(chn_name, "江西")) {
      eng_name <- "Jiangxi"
    } else if (str_detect(chn_name, "河北")) {
      eng_name <- "Hebei"
    } else if (str_detect(chn_name, "河南")) {
      eng_name <- "Henan"
    } else if (str_detect(chn_name, "浙江")) {
      eng_name <- "Zhejiang"
    } else if (str_detect(chn_name, "海南")) {
      eng_name <- "Hainan"
    } else if (str_detect(chn_name, "湖北")) {
      eng_name <- "Hubei"
    } else if (str_detect(chn_name, "湖南")) {
      eng_name <- "Hunan"
    } else if (str_detect(chn_name, "甘肃")) {
      eng_name <- "Gansu"
    } else if (str_detect(chn_name, "福建")) {
      eng_name <- "Fujian"
    } else if (str_detect(chn_name, "西藏")) {
      eng_name <- "Tibet"
    } else if (str_detect(chn_name, "贵州")) {
      eng_name <- "Guizhou"
    } else if (str_detect(chn_name, "辽宁")) {
      eng_name <- "Liaoning"
    } else if (str_detect(chn_name, "重庆")) {
      eng_name <- "Chongqing"
    } else if (str_detect(chn_name, "陕西")) {
      eng_name <- "Shanxi"
    } else if (str_detect(chn_name, "青海")) {
      eng_name <- "Qinghai"
    } else if (str_detect(chn_name, "香港")) {
      eng_name <- "Hong Kong"
    } else if (str_detect(chn_name, "黑龙江")) {
      eng_name <- "Heilongjiang"
    } else {
      eng_name <- chn_name # don't translate if no correspondence
    }
    return(eng_name)
  })
}
```
Create a new variable `NAME_ENG`:
```{r}
chn_prov <- chn_map %>% 
  count(NAME) %>%
  mutate(NAME_ENG = translate(NAME))
chn_prov %>% print(n = Inf)
```

## Plotting 2019-nCoV incidence

Confirmed cases:
```{r}
plotdate <- "2020-01-25"
ncov_tbl %>%
  filter(`Country/Region` %in% c("Mainland China", "Macau", "Hong Kong", "Taiwan")) %>%
  mutate(date = date(time)) %>%
  group_by(`Province/State`, date) %>%  
  arrange(time) %>%
  summarise(last(confirmed)) %>%
  filter(date == plotdate) %>%
  right_join(chn_prov, by = c("Province/State" = "NAME_ENG")) %>%
  ggplot() + 
  geom_sf(mapping = aes(fill = `last(confirmed)`, geometry = geometry)) +
  theme_bw() +
  labs(title = "Confirmed Cases", subtitle = plotdate)
```

## Mapping countries

TODO
